(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{485:function(t,a,e){"use strict";e.r(a);var s=e(42),n=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"solidity极简入门-12-事件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#solidity极简入门-12-事件"}},[t._v("#")]),t._v(" Solidity极简入门: 12. 事件")]),t._v(" "),e("p",[t._v("我最近在重新学solidity，巩固一下细节，也写一个“Solidity极简入门”，供小白们使用（编程大佬可以另找教程），每周更新1-3讲。")]),t._v(" "),e("p",[t._v("欢迎关注我的推特："),e("a",{attrs:{href:"https://twitter.com/0xAA_Science",target:"_blank",rel:"noopener noreferrer"}},[t._v("@0xAA_Science"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("WTF技术社群discord，内有加微信群方法："),e("a",{attrs:{href:"https://discord.gg/5akcruXrsk",target:"_blank",rel:"noopener noreferrer"}},[t._v("链接"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("所有代码和教程开源在github（1024个star发课程认证，2048个star发社群NFT）: "),e("a",{attrs:{href:"https://github.com/AmazingAng/WTFSolidity",target:"_blank",rel:"noopener noreferrer"}},[t._v("github.com/AmazingAng/WTFSolidity"),e("OutboundLink")],1)]),t._v(" "),e("hr"),t._v(" "),e("p",[t._v("这一讲，我们用转账ERC20代币为例来介绍"),e("code",[t._v("solidity")]),t._v("中的事件（"),e("code",[t._v("event")]),t._v("）。")]),t._v(" "),e("h2",{attrs:{id:"事件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#事件"}},[t._v("#")]),t._v(" 事件")]),t._v(" "),e("p",[e("code",[t._v("Solidity")]),t._v("中的事件（"),e("code",[t._v("event")]),t._v("）是"),e("code",[t._v("EVM")]),t._v("上日志的抽象，它具有两个特点：")]),t._v(" "),e("ul",[e("li",[t._v("响应：应用程序（"),e("a",{attrs:{href:"https://learnblockchain.cn/docs/ethers.js/api-contract.html#id18",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("ether.js")]),e("OutboundLink")],1),t._v("）可以通过"),e("code",[t._v("RPC")]),t._v("接口订阅和监听这些事件，并在前端做响应。")]),t._v(" "),e("li",[t._v("经济：事件是"),e("code",[t._v("EVM")]),t._v("上比较经济的存储数据的方式，每个大概消耗2,000 "),e("code",[t._v("gas")]),t._v("；相比之下，链上存储一个新变量至少需要20,000 "),e("code",[t._v("gas")]),t._v("。")])]),t._v(" "),e("h3",{attrs:{id:"规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#规则"}},[t._v("#")]),t._v(" 规则")]),t._v(" "),e("p",[t._v("事件的声明由"),e("code",[t._v("event")]),t._v("关键字开头，然后跟事件名称，括号里面写好事件需要记录的变量类型和变量名。以"),e("code",[t._v("ERC20")]),t._v("代币合约的"),e("code",[t._v("Transfer")]),t._v("事件为例：")]),t._v(" "),e("div",{staticClass:"language-solidity extra-class"},[e("pre",{pre:!0,attrs:{class:"language-solidity"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("event")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Transfer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("indexed")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("indexed")]),t._v(" to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint256")]),t._v(" value"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("我们可以看到，"),e("code",[t._v("Transfer")]),t._v("事件共记录了3个变量"),e("code",[t._v("from")]),t._v("，"),e("code",[t._v("to")]),t._v("和"),e("code",[t._v("value")]),t._v("，分别对应代币的转账地址，接收地址和转账数量。")]),t._v(" "),e("p",[t._v("同时"),e("code",[t._v("from")]),t._v("和"),e("code",[t._v("to")]),t._v("前面带着"),e("code",[t._v("indexed")]),t._v("关键字，每个"),e("code",[t._v("indexed")]),t._v("标记的变量可以理解为检索事件的索引“键”，在以太坊上单独作为一个 topic 进行存储和索引，程序可以轻松的筛选出特定转账地址和接收地址的转账事件。每个事件最多有3个带"),e("code",[t._v("indexed")]),t._v("的变量。事件的哈希以及这三个带"),e("code",[t._v("indexed")]),t._v("的变量在英文技术文档往往也被称为 "),e("code",[t._v("topic[0]")]),t._v(" 到 "),e("code",[t._v("topic[2]")]),t._v("。每个 "),e("code",[t._v("indexed")]),t._v(" 变量的大小为固定的256比特。")]),t._v(" "),e("p",[e("code",[t._v("value")]),t._v(" 不带 "),e("code",[t._v("indexed")]),t._v(" 关键字，会存储在事件的 "),e("code",[t._v("data")]),t._v(" 部分中，可以理解为事件的“值”。"),e("code",[t._v("data")]),t._v(" 部分的变量不能被直接检索，但可以存储任意大小的数据。因此一般 "),e("code",[t._v("data")]),t._v(" 部分可以用来存储复杂的数据结构，例如数组和字符串等等，因为这些数据超过了256比特，即使存储在事件的 "),e("code",[t._v("topic")]),t._v(" 部分中，也是以哈希的方式存储。另外，"),e("code",[t._v("data")]),t._v(" 部分的变量在存储上消耗的gas相比于 "),e("code",[t._v("topic")]),t._v(" 更少。")]),t._v(" "),e("p",[t._v("我们可以在函数里释放事件。在下面的例子中，每次用"),e("code",[t._v("_transfer()")]),t._v("函数进行转账操作的时候，都会释放"),e("code",[t._v("Transfer")]),t._v("事件，并记录相应的变量。")]),t._v(" "),e("div",{staticClass:"language-solidity extra-class"},[e("pre",{pre:!0,attrs:{class:"language-solidity"}},[e("code",[t._v("    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 定义_transfer函数，执行转账逻辑")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("_transfer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint256")]),t._v(" amount\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("external")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n        _balances"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 给转账地址一些初始代币")]),t._v("\n\n        _balances"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-=")]),t._v("  amount"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// from地址减去转账数量")]),t._v("\n        _balances"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" amount"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// to地址加上转账数量")]),t._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 释放事件")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("emit")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Transfer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h3",{attrs:{id:"remix-演示"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#remix-演示"}},[t._v("#")]),t._v(" Remix 演示")]),t._v(" "),e("p",[t._v("以 "),e("code",[t._v("Event.sol")]),t._v(" 合约为例，编译部署。")]),t._v(" "),e("p",[t._v("然后调用 "),e("code",[t._v("_transfer")]),t._v(" 函数。\n"),e("img",{attrs:{src:"img/12-1.jpg",alt:""}})]),t._v(" "),e("p",[t._v("点击右侧的交易查看详情，可以看到日志的具体内容。\n"),e("img",{attrs:{src:"img/12-2.jpg",alt:""}})]),t._v(" "),e("h3",{attrs:{id:"在etherscan上查询事件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在etherscan上查询事件"}},[t._v("#")]),t._v(" 在etherscan上查询事件")]),t._v(" "),e("p",[t._v("我们尝试用"),e("code",[t._v("_transfer()")]),t._v("函数在"),e("code",[t._v("Rinkeby")]),t._v("测试网络上转账100代币，可以在"),e("code",[t._v("etherscan")]),t._v("上查询到相应的"),e("code",[t._v("tx")]),t._v("："),e("a",{attrs:{href:"https://rinkeby.etherscan.io/tx/0x8cf87215b23055896d93004112bbd8ab754f081b4491cb48c37592ca8f8a36c7",target:"_blank",rel:"noopener noreferrer"}},[t._v("网址"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("p",[t._v("点击"),e("code",[t._v("Logs")]),t._v("按钮，就能看到事件明细：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://images.mirror-media.xyz/publication-images/gx6_wDMYEl8_Gc_JkTIKn.png?height=980&width=1772",alt:"Event明细"}})]),t._v(" "),e("p",[e("code",[t._v("Topics")]),t._v("里面有三个元素，"),e("code",[t._v("[0]")]),t._v("是这个事件的哈希，"),e("code",[t._v("[1]")]),t._v("和"),e("code",[t._v("[2]")]),t._v("是我们定义的两个"),e("code",[t._v("indexed")]),t._v("变量的信息，即转账的转出地址和接收地址。"),e("code",[t._v("Data")]),t._v("里面是剩下的不带"),e("code",[t._v("indexed")]),t._v("的变量，也就是转账数量。")]),t._v(" "),e("h2",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),e("p",[t._v("这一讲，我们介绍了如何使用和查询"),e("code",[t._v("solidity")]),t._v("中的事件。很多链上分析工具包括"),e("code",[t._v("Nansen")]),t._v("和"),e("code",[t._v("Dune Analysis")]),t._v("都是基于事件工作的。")])])}),[],!1,null,null,null);a.default=n.exports}}]);