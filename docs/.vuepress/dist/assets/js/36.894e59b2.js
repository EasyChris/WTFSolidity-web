(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{427:function(t,a,s){t.exports=s.p+"assets/img/25-1.80e469d0.png"},498:function(t,a,s){"use strict";s.r(a);var n=s(42),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"solidity极简入门-24-create2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#solidity极简入门-24-create2"}},[t._v("#")]),t._v(" Solidity极简入门: 24. Create2")]),t._v(" "),n("p",[t._v("我最近在重新学solidity，巩固一下细节，也写一个“Solidity极简入门”，供小白们使用（编程大佬可以另找教程），每周更新1-3讲。")]),t._v(" "),n("p",[t._v("欢迎关注我的推特："),n("a",{attrs:{href:"https://twitter.com/0xAA_Science",target:"_blank",rel:"noopener noreferrer"}},[t._v("@0xAA_Science"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("欢迎加入WTF科学家社群，内有加微信群方法："),n("a",{attrs:{href:"https://discord.gg/5akcruXrsk",target:"_blank",rel:"noopener noreferrer"}},[t._v("链接"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("所有代码和教程开源在github（1024个star发课程认证，2048个star发社群NFT）: "),n("a",{attrs:{href:"https://github.com/AmazingAng/WTFSolidity",target:"_blank",rel:"noopener noreferrer"}},[t._v("github.com/AmazingAng/WTFSolidity"),n("OutboundLink")],1)]),t._v(" "),n("hr"),t._v(" "),n("h2",{attrs:{id:"create2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#create2"}},[t._v("#")]),t._v(" CREATE2")]),t._v(" "),n("p",[n("code",[t._v("CREATE2")]),t._v(" 操作码使我们在智能合约部署在以太坊网络之前就能预测合约的地址。"),n("code",[t._v("Uniswap")]),t._v("创建"),n("code",[t._v("Pair")]),t._v("合约用的就是"),n("code",[t._v("CREATE2")]),t._v("而不是"),n("code",[t._v("CREATE")]),t._v("。这一讲，我将介绍"),n("code",[t._v("CREATE2")]),t._v("的用法")]),t._v(" "),n("h3",{attrs:{id:"create如何计算地址"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#create如何计算地址"}},[t._v("#")]),t._v(" CREATE如何计算地址")]),t._v(" "),n("p",[t._v("智能合约可以由其他合约和普通账户利用"),n("code",[t._v("CREATE")]),t._v("操作码创建。 在这两种情况下，新合约的地址都以相同的方式计算：创建者的地址(通常为部署的钱包地址或者合约地址)和"),n("code",[t._v("nonce")]),t._v("(该地址发送交易的总数,对于合约账户是创建的合约总数,每创建一个合约nonce+1))的哈希。")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("新地址 = hash(创建者地址, nonce)\n")])])]),n("p",[t._v("创建者地址不会变，但"),n("code",[t._v("nonce")]),t._v("可能会随时间而改变，因此用"),n("code",[t._v("CREATE")]),t._v("创建的合约地址不好预测。")]),t._v(" "),n("h3",{attrs:{id:"create2如何计算地址"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#create2如何计算地址"}},[t._v("#")]),t._v(" CREATE2如何计算地址")]),t._v(" "),n("p",[n("code",[t._v("CREATE2")]),t._v("的目的是为了让合约地址独立于未来的事件。不管未来区块链上发生了什么，你都可以把合约部署在事先计算好的地址上。用"),n("code",[t._v("CREATE2")]),t._v("创建的合约地址由4个部分决定：")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("0xFF")]),t._v("：一个常数，避免和"),n("code",[t._v("CREATE")]),t._v("冲突")]),t._v(" "),n("li",[t._v("创建者地址")]),t._v(" "),n("li",[n("code",[t._v("salt")]),t._v("（盐）：一个创建者给定的数值")]),t._v(" "),n("li",[t._v("待部署合约的字节码（"),n("code",[t._v("bytecode")]),t._v("）")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('新地址 = hash("0xFF",创建者地址, salt, bytecode)\n')])])]),n("p",[n("code",[t._v("CREATE2")]),t._v(" 确保，如果创建者使用 "),n("code",[t._v("CREATE2")]),t._v(" 和提供的 "),n("code",[t._v("salt")]),t._v(" 部署给定的合约"),n("code",[t._v("bytecode")]),t._v("，它将存储在 "),n("code",[t._v("新地址")]),t._v(" 中。")]),t._v(" "),n("h2",{attrs:{id:"如何使用create2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何使用create2"}},[t._v("#")]),t._v(" 如何使用"),n("code",[t._v("CREATE2")])]),t._v(" "),n("p",[n("code",[t._v("CREATE2")]),t._v("的用法和之前讲的"),n("code",[t._v("Create")]),t._v("类似，同样是"),n("code",[t._v("new")]),t._v("一个合约，并传入新合约构造函数所需的参数，只不过要多传一个"),n("code",[t._v("salt")]),t._v("参数：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("Contract x = new Contract{salt: _salt, value: _value}(params)\n")])])]),n("p",[t._v("其中"),n("code",[t._v("Contract")]),t._v("是要创建的合约名，"),n("code",[t._v("x")]),t._v("是合约对象（地址），"),n("code",[t._v("_salt")]),t._v("是指定的盐；如果构造函数是"),n("code",[t._v("payable")]),t._v("，可以创建时转入"),n("code",[t._v("_value")]),t._v("数量的"),n("code",[t._v("ETH")]),t._v("，"),n("code",[t._v("params")]),t._v("是新合约构造函数的参数。")]),t._v(" "),n("h2",{attrs:{id:"极简uniswap2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#极简uniswap2"}},[t._v("#")]),t._v(" 极简Uniswap2")]),t._v(" "),n("p",[t._v("跟"),n("a",{attrs:{href:"https://mirror.xyz/dashboard/edit/kojopp2CgDK3ehHxXc_2fkZe87uM0O5OmsEU6y83eJs",target:"_blank",rel:"noopener noreferrer"}},[t._v("上一讲"),n("OutboundLink")],1),t._v("类似，我们用"),n("code",[t._v("Create2")]),t._v("来实现极简"),n("code",[t._v("Uniswap")]),t._v("。")]),t._v(" "),n("h3",{attrs:{id:"pair"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pair"}},[t._v("#")]),t._v(" "),n("code",[t._v("Pair")])]),t._v(" "),n("div",{staticClass:"language-solidity extra-class"},[n("pre",{pre:!0,attrs:{class:"language-solidity"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("contract")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Pair")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 工厂合约地址")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" token0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 代币1")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" token1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 代币2")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("constructor")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("payable")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        factory "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sender"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// called once by the factory at time of deployment")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("initialize")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" _token0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" _token1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("external")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sender "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'UniswapV2: FORBIDDEN'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// sufficient check")]),t._v("\n        token0 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" _token0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        token1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" _token1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[n("code",[t._v("Pair")]),t._v("合约很简单，包含3个状态变量："),n("code",[t._v("factory")]),t._v("，"),n("code",[t._v("token0")]),t._v("和"),n("code",[t._v("token1")]),t._v("。")]),t._v(" "),n("p",[t._v("构造函数"),n("code",[t._v("constructor")]),t._v("在部署时将"),n("code",[t._v("factory")]),t._v("赋值为工厂合约地址。"),n("code",[t._v("initialize")]),t._v("函数会在"),n("code",[t._v("Pair")]),t._v("合约创建的时候被工厂合约调用一次，将"),n("code",[t._v("token0")]),t._v("和"),n("code",[t._v("token1")]),t._v("更新为币对中两种代币的地址。")]),t._v(" "),n("h3",{attrs:{id:"pairfactory2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pairfactory2"}},[t._v("#")]),t._v(" "),n("code",[t._v("PairFactory2")])]),t._v(" "),n("div",{staticClass:"language-solidity extra-class"},[n("pre",{pre:!0,attrs:{class:"language-solidity"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("contract")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PairFactory2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mapping")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mapping")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" getPair"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 通过两个代币地址查Pair地址")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" allPairs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 保存所有Pair地址")]),t._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("createPair2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" tokenA"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" tokenB"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("external")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("returns")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" pairAddr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 计算用tokenA和tokenB地址计算salt")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" token0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" token1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tokenA "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" tokenB "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tokenA"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tokenB"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tokenB"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tokenA"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//将tokenA和tokenB按大小排序")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bytes32")]),t._v(" salt "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("keccak256")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("encodePacked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" token1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用create2部署新合约")]),t._v("\n            Pair pair "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Pair")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("salt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" salt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调用新合约的initialize方法")]),t._v("\n            pair"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("initialize")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tokenA"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tokenB"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 更新地址map")]),t._v("\n            pairAddr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pair"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            allPairs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pairAddr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            getPair"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("tokenA"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("tokenB"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pairAddr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            getPair"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("tokenB"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("tokenA"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pairAddr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("工厂合约（"),n("code",[t._v("PairFactory2")]),t._v("）有两个状态变量"),n("code",[t._v("getPair")]),t._v("是两个代币地址到币对地址的"),n("code",[t._v("map")]),t._v("，方便根据代币找到币对地址；"),n("code",[t._v("allPairs")]),t._v("是币对地址的数组，存储了所有代币地址。")]),t._v(" "),n("p",[n("code",[t._v("PairFactory2")]),t._v("合约只有一个"),n("code",[t._v("createPair2")]),t._v("函数，使用"),n("code",[t._v("CREATE2")]),t._v("根据输入的两个代币地址"),n("code",[t._v("tokenA")]),t._v("和"),n("code",[t._v("tokenB")]),t._v("来创建新的"),n("code",[t._v("Pair")]),t._v("合约。其中")]),t._v(" "),n("div",{staticClass:"language-solidity extra-class"},[n("pre",{pre:!0,attrs:{class:"language-solidity"}},[n("code",[t._v("    Pair pair "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Pair")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("salt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" salt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n")])])]),n("p",[t._v("就是利用"),n("code",[t._v("CREATE2")]),t._v("创建合约的代码，非常简单，而"),n("code",[t._v("salt")]),t._v("为"),n("code",[t._v("token1")]),t._v("和"),n("code",[t._v("token2")]),t._v("的"),n("code",[t._v("hash")]),t._v("：")]),t._v(" "),n("div",{staticClass:"language-solidity extra-class"},[n("pre",{pre:!0,attrs:{class:"language-solidity"}},[n("code",[t._v("            "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bytes32")]),t._v(" salt "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("keccak256")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("encodePacked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" token1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("h3",{attrs:{id:"事先计算pair地址"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事先计算pair地址"}},[t._v("#")]),t._v(" 事先计算"),n("code",[t._v("Pair")]),t._v("地址")]),t._v(" "),n("div",{staticClass:"language-solidity extra-class"},[n("pre",{pre:!0,attrs:{class:"language-solidity"}},[n("code",[t._v("        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 提前计算pair合约地址")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("calculateAddr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" tokenA"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" tokenB"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("view")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("returns")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" predictedAddress"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 计算用tokenA和tokenB地址计算salt")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" token0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),t._v(" token1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tokenA "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" tokenB "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tokenA"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tokenB"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tokenB"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tokenA"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//将tokenA和tokenB按大小排序")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bytes32")]),t._v(" salt "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("keccak256")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("encodePacked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" token1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 计算合约地址方法 hash()")]),t._v("\n            predictedAddress "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint160")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("keccak256")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("encodePacked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bytes1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0xff")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("address")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                salt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("keccak256")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Pair"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("creationCode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("我们写了一个"),n("code",[t._v("calculateAddr")]),t._v("函数来事先计算"),n("code",[t._v("tokenA")]),t._v("和"),n("code",[t._v("tokenB")]),t._v("将会生成的"),n("code",[t._v("Pair")]),t._v("地址。通过它，我们可以验证我们事先计算的地址和实际地址是否相同。")]),t._v(" "),n("p",[t._v("大家可以部署好"),n("code",[t._v("PairFactory2")]),t._v("合约，然后用下面两个地址作为参数调用"),n("code",[t._v("createPair2")]),t._v("，看看创建的币对地址是什么，是否与事先计算的地址一样：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("WBNB地址: 0x2c44b726ADF1963cA47Af88B284C06f30380fC78\nBSC链上的PEOPLE地址:\n0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c\n")])])]),n("h3",{attrs:{id:"在remix上验证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#在remix上验证"}},[t._v("#")]),t._v(" 在remix上验证")]),t._v(" "),n("ol",[n("li",[t._v("首先用"),n("code",[t._v("WBNB")]),t._v("和"),n("code",[t._v("PEOPLE")]),t._v("的地址哈希作为"),n("code",[t._v("salt")]),t._v("来计算出"),n("code",[t._v("Pair")]),t._v("合约的地址")]),t._v(" "),n("li",[t._v("调用"),n("code",[t._v("PairFactory2.createPair2")]),t._v("传入参数为"),n("code",[t._v("WBNB")]),t._v("和"),n("code",[t._v("PEOPLE")]),t._v("的地址，获取出创建的"),n("code",[t._v("pair")]),t._v("合约地址")]),t._v(" "),n("li",[t._v("对比合约地址\n"),n("img",{attrs:{src:s(427),alt:"create2_remix_test.png"}})])]),t._v(" "),n("h2",{attrs:{id:"create2的实际应用场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#create2的实际应用场景"}},[t._v("#")]),t._v(" create2的实际应用场景")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("交易所为新用户预留创建钱包合约地址。")])]),t._v(" "),n("li",[n("p",[t._v("由 "),n("code",[t._v("CREATE2")]),t._v(" 驱动的 "),n("code",[t._v("factory")]),t._v(" 合约，在"),n("code",[t._v("uniswapV2")]),t._v("中交易对的创建是在 "),n("code",[t._v("Factory")]),t._v("中调用"),n("code",[t._v("create2")]),t._v("完成。这样做的好处是: 它可以得到一个确定的"),n("code",[t._v("pair")]),t._v("地址, 使得 "),n("code",[t._v("Router")]),t._v("中就可以通过 "),n("code",[t._v("(tokenA, tokenB)")]),t._v(" 计算出"),n("code",[t._v("pair")]),t._v("地址, 不再需要执行一次 "),n("code",[t._v("Factory.getPair(tokenA, tokenB)")]),t._v(" 的跨合约调用。")])])]),t._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),n("p",[t._v("这一讲，我们介绍了"),n("code",[t._v("CREATE2")]),t._v("操作码的原理，使用方法，并用它完成了极简版的"),n("code",[t._v("Uniswap")]),t._v("并提前计算币对合约地址。"),n("code",[t._v("CREATE2")]),t._v("让我们可以在部署合约前确定它的合约地址，这也是\n一些"),n("code",[t._v("layer2")]),t._v("项目的基础。")])])}),[],!1,null,null,null);a.default=e.exports}}]);